---
// SearchModal.astro - Full-screen search modal with Pagefind integration
import "@pagefind/default-ui/css/ui.css";
---

<div id="search-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="search-title">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity opacity-0" aria-hidden="true"></div>

  <!-- Modal Content -->
  <div class="absolute inset-0 flex items-start justify-center pt-[20vh] px-4">
    <div id="search-panel" class="relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" role="search">
      <!-- Search Header -->
      <div class="flex items-center gap-4 p-6 border-b border-slate-200 flex-shrink-0">
        <div class="flex-1">
          <div id="search" class="relative"></div>
        </div>
        <button
          id="search-close"
          class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors flex-shrink-0"
          aria-label="閉じる">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Search Footer -->
      <div class="p-4 border-t border-slate-200 flex items-center justify-between text-sm text-slate-500 flex-shrink-0">
        <div class="flex items-center gap-2">
          <kbd class="px-2 py-1 bg-slate-100 rounded text-xs font-mono">ESC</kbd>
          <span>で閉じる</span>
        </div>
        <div class="flex items-center gap-2">
          <kbd class="px-2 py-1 bg-slate-100 rounded text-xs font-mono">Cmd+K</kbd>
          <span>で検索</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  #search-modal:not(.hidden) {
    display: block;
  }

  #search-panel.open {
    opacity: 1;
    transform: scale(1);
  }

  #search-backdrop.open {
    opacity: 1;
  }

  /* Override Pagefind default styles to match our design */
  #search .pagefind-ui__search-input {
    width: 100% !important;
    padding: 0.75rem 3rem 0.75rem 1rem !important;
    font-size: 1rem !important;
    border: none !important;
    background: transparent !important;
  }

  #search .pagefind-ui__search-bar {
    border: none !important;
    background: rgb(241 245 244 / 1) !important;
    border-radius: 0.75rem !important;
    padding: 0.5rem !important;
  }

  /* Hide the default magnifying glass icon (implemented as ::before pseudo-element) */
  #search .pagefind-ui__form:before {
    display: none !important;
  }

  #search .pagefind-ui__drawer {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    border: none !important;
    box-shadow: none !important;
    max-height: 60vh !important;
    z-index: 10 !important;
    background: white !important;
    padding: 0 0.5rem 0.5rem !important;
    margin-top: 0.5rem !important;
  }

  #search .pagefind-ui__result-title {
    color: rgb(15 23 42 / 1) !important;
    font-weight: 600 !important;
  }

  #search .pagefind-ui__result:hover .pagefind-ui__result-title {
    color: rgb(13 148 136 / 1) !important;
  }

  #search .pagefind-ui__result-excerpt {
    color: rgb(100 116 139 / 1) !important;
  }

  #search mark {
    background-color: rgb(251 191 36 / 0.3) !important;
    color: inherit !important;
    padding: 0 0.125rem !important;
    border-radius: 0.125rem !important;
  }
</style>

<script>
  // @ts-ignore - PagefindUI doesn't have TypeScript definitions
  import { PagefindUI } from "@pagefind/default-ui";

  const modal = document.getElementById('search-modal');
  const backdrop = document.getElementById('search-backdrop');
  const panel = document.getElementById('search-panel');
  const closeBtn = document.getElementById('search-close');

  // Initialize PagefindUI
  let pagefindUI: PagefindUI | null = null;

  function initPagefind() {
    if (pagefindUI) return;

    try {
      pagefindUI = new PagefindUI({
        element: "#search",
        showSubResults: true,
        excerptLength: 30,
        translations: {
          placeholder: "サイト内検索...",
        }
      });
    } catch (e) {
      console.error('Failed to initialize PagefindUI:', e);
    }
  }

  // Open search modal
  function openSearch() {
    modal?.classList.remove('hidden');
    // Trigger animation
    setTimeout(() => {
      panel?.classList.add('open');
      backdrop?.classList.add('open');
    }, 10);
    document.body.style.overflow = 'hidden';

    // Initialize PagefindUI on first open
    initPagefind();

    // Focus the search input
    setTimeout(() => {
      const input = modal?.querySelector('input[type="text"]');
      input?.focus();
    }, 100);
  }

  // Close search modal
  function closeSearch() {
    panel?.classList.remove('open');
    backdrop?.classList.remove('open');
    setTimeout(() => {
      modal?.classList.add('hidden');
      // Clear search
      const input = modal?.querySelector('input[type="text"]') as HTMLInputElement;
      if (input) {
        input.value = '';
        input.dispatchEvent(new Event('input'));
      }
    }, 300);
    document.body.style.overflow = '';
  }

  // Event listeners
  closeBtn?.addEventListener('click', closeSearch);
  backdrop?.addEventListener('click', closeSearch);

  // Global keyboard shortcut (Cmd/Ctrl + K)
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal?.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }

    // Close on Escape
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeSearch();
    }
  });

  // Expose openSearch function globally for search button
  (window as any).openSearch = openSearch;
</script>
