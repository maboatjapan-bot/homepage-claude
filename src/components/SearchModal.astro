---
// SearchModal.astro - Full-screen search modal with Pagefind integration
---

<div id="search-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="search-title">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity opacity-0" aria-hidden="true"></div>

  <!-- Modal Content -->
  <div class="absolute inset-0 flex items-start justify-center pt-[20vh] px-4">
    <div id="search-panel" class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl transform transition-all scale-95 opacity-0" role="search">
      <!-- Search Header -->
      <div class="flex items-center gap-4 p-6 border-b border-slate-200">
        <div class="flex-1 relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input
            id="search-input"
            type="text"
            placeholder="サイト内検索..."
            class="w-full pl-12 pr-4 py-3 bg-slate-100 rounded-xl text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-brand-teal/20"
            autocomplete="off"
          />
        </div>
        <button
          id="search-close"
          class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
          aria-label="閉じる">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Search Results -->
      <div class="max-h-[60vh] overflow-y-auto">
        <div id="search-loading" class="hidden p-8 text-center text-slate-500">
          <svg class="animate-spin w-8 h-8 mx-auto mb-4 text-brand-teal" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p>検索中...</p>
        </div>

        <div id="search-results" class="hidden">
          <!-- Results will be injected here -->
        </div>

        <div id="search-empty" class="hidden p-8 text-center text-slate-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-lg mb-2">結果が見つかりませんでした</p>
          <p class="text-sm">別のキーワードで検索してください</p>
        </div>

        <div id="search-initial" class="p-8 text-center text-slate-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <p class="text-lg mb-2">キーワードを入力して検索</p>
          <p class="text-sm">ページタイトルや本文から検索できます</p>
        </div>
      </div>

      <!-- Search Footer -->
      <div class="p-4 border-t border-slate-200 flex items-center justify-between text-sm text-slate-500">
        <div class="flex items-center gap-2">
          <kbd class="px-2 py-1 bg-slate-100 rounded text-xs font-mono">ESC</kbd>
          <span>で閉じる</span>
        </div>
        <div class="flex items-center gap-2">
          <kbd class="px-2 py-1 bg-slate-100 rounded text-xs font-mono">↑↓</kbd>
          <span>で移動</span>
          <kbd class="px-2 py-1 bg-slate-100 rounded text-xs font-mono">Enter</kbd>
          <span>で選択</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #search-modal:not(.hidden) {
    display: block;
  }

  #search-panel.open {
    opacity: 1;
    transform: scale(1);
  }

  #search-backdrop.open {
    opacity: 1;
  }

  .result-item {
    display: block;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgb(226 232 240 / 1);
    text-decoration: none;
    color: rgb(15 23 42 / 1);
    transition: all 0.2s;
  }

  .result-item:first-child {
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0.5rem;
  }

  .result-item:last-child {
    border-bottom: none;
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
  }

  .result-item:hover,
  .result-item.selected {
    background-color: rgb(236 253 245 / 1);
  }

  .result-title {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.25rem;
    color: rgb(15 23 42 / 1);
  }

  .result-excerpt {
    font-size: 0.875rem;
    color: rgb(100 116 139 / 1);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  /* Highlight matching text */
  mark {
    background-color: rgb(251 191 36 / 0.3);
    color: inherit;
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }
</style>

<!-- Pagefind script - will be loaded at runtime -->
<script src="/pagefind/pagefind.js" async></script>

<script>
  // Search functionality with Pagefind
  let searchIndex = null;
  let selectedIndex = -1;
  let results = [];
  let pagefindLoading = false;

  const modal = document.getElementById('search-modal');
  const backdrop = document.getElementById('search-backdrop');
  const panel = document.getElementById('search-panel');
  const input = document.getElementById('search-input');
  const closeBtn = document.getElementById('search-close');
  const resultsContainer = document.getElementById('search-results');
  const loadingEl = document.getElementById('search-loading');
  const emptyEl = document.getElementById('search-empty');
  const initialEl = document.getElementById('search-initial');

  // Open search modal
  function openSearch() {
    modal.classList.remove('hidden');
    // Trigger animation
    setTimeout(() => {
      panel.classList.add('open');
      backdrop.classList.add('open');
    }, 10);
    input.focus();
    document.body.style.overflow = 'hidden';

    // Initialize Pagefind search
    if (!searchIndex && !pagefindLoading) {
      initSearch();
    }
  }

  // Close search modal
  function closeSearch() {
    panel.classList.remove('open');
    backdrop.classList.remove('open');
    setTimeout(() => {
      modal.classList.add('hidden');
      input.value = '';
      clearResults();
      selectedIndex = -1;
    }, 300);
    document.body.style.overflow = '';
  }

  // Initialize Pagefind search
  async function initSearch() {
    pagefindLoading = true;
    try {
      // Wait for pagefind to load (with timeout)
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max

      while (typeof window.pagefind === 'undefined' && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (typeof window.pagefind === 'undefined') {
        throw new Error('Pagefind failed to load');
      }

      searchIndex = window.pagefind;
    } catch (e) {
      console.error('Failed to initialize Pagefind:', e);
      initialEl.innerHTML = `
        <p class="text-red-500 mb-2">検索機能を読み込めませんでした</p>
        <p class="text-sm text-slate-500">本番環境または「npm run preview」で動作します</p>
        <p class="text-xs text-slate-400 mt-2">検索には「npm run build:search」後のビルド済みファイルが必要です</p>
      `;
    }
    pagefindLoading = false;
  }

  // Clear results
  function clearResults() {
    resultsContainer.innerHTML = '';
    resultsContainer.classList.add('hidden');
    loadingEl.classList.add('hidden');
    emptyEl.classList.add('hidden');
    initialEl.classList.remove('hidden');
  }

  // Perform search
  async function performSearch(query) {
    if (!query || query.trim() === '') {
      clearResults();
      return;
    }

    initialEl.classList.add('hidden');
    loadingEl.classList.remove('hidden');
    emptyEl.classList.add('hidden');
    resultsContainer.classList.add('hidden');

    if (!searchIndex) {
      // Wait for pagefind to load
      setTimeout(() => performSearch(query), 100);
      return;
    }

    try {
      const searchResults = await searchIndex.search(query);
      loadingEl.classList.add('hidden');

      if (!searchResults || searchResults.results.length === 0) {
        emptyEl.classList.remove('hidden');
        return;
      }

      results = searchResults.results;
      displayResults(results);
    } catch (e) {
      console.error('Search error:', e);
      loadingEl.classList.add('hidden');
    }
  }

  // Display results
  function displayResults(resultsData) {
    resultsContainer.innerHTML = '';
    resultsContainer.classList.remove('hidden');

    resultsData.slice(0, 8).forEach((result, index) => {
      const link = document.createElement('a');
      link.className = 'result-item';
      link.href = result.url;
      link.dataset.index = index;

      link.innerHTML = `
        <div class="result-title">${result.meta?.title || result.url}</div>
        ${result.excerpt ? `<div class="result-excerpt">${result.excerpt}</div>` : ''}
      `;

      link.addEventListener('click', () => closeSearch());
      resultsContainer.appendChild(link);
    });
  }

  // Update selected result
  function updateSelection() {
    const items = resultsContainer.querySelectorAll('.result-item');
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.classList.add('selected');
        item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        item.classList.remove('selected');
      }
    });
  }

  // Event listeners
  closeBtn?.addEventListener('click', closeSearch);
  backdrop?.addEventListener('click', closeSearch);

  input?.addEventListener('input', (e) => {
    selectedIndex = -1;
    performSearch(e.target.value);
  });

  // Keyboard navigation
  input?.addEventListener('keydown', (e) => {
    const items = resultsContainer.querySelectorAll('.result-item');

    switch (e.key) {
      case 'Escape':
        e.preventDefault();
        closeSearch();
        break;
      case 'ArrowDown':
        e.preventDefault();
        if (items.length > 0 && selectedIndex < items.length - 1) {
          selectedIndex++;
          updateSelection();
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (selectedIndex > 0) {
          selectedIndex--;
          updateSelection();
        }
        break;
      case 'Enter':
        if (selectedIndex >= 0 && items[selectedIndex]) {
          items[selectedIndex].click();
        }
        break;
    }
  });

  // Global keyboard shortcut (Cmd/Ctrl + K)
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }
  });

  // Expose openSearch function globally for search button
  window.openSearch = openSearch;
</script>
