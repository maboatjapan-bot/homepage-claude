---
// SearchMenu.astro - Dual search dropdown menu (PageFind + Google AI)
---

<!-- Google AI Search Widget (embedded in menu, initially hidden) -->
<div id="google-ai-widget-container" class="hidden">
  <gen-search-widget
    configId="bdff1d11-8603-47e8-851d-747312e6e3f5"
    triggerId="google-ai-search-trigger"
    anchorsTarget="_blank">
  </gen-search-widget>

  <!-- Trigger input for Google Widget (visible when widget is shown) -->
  <input
    id="google-ai-search-trigger"
    type="text"
    placeholder="何でもお尋ねください..."
    class="w-full px-4 py-3 text-base border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-teal/50 focus:border-brand-teal/50"
  />
</div>

<!-- Search Dropdown Menu -->
<div
  id="search-menu"
  class="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden transition-all duration-200 opacity-0 scale-95 pointer-events-none z-50"
  aria-hidden="true">

  <!-- PageFind Search (Keyword) -->
  <button
    id="pagefind-search-btn"
    class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-colors text-left"
    aria-label="キーワード検索">
    <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <div class="text-sm font-semibold text-slate-900">キーワード検索</div>
      <div class="text-xs text-slate-500">無料・サイト内全文検索</div>
    </div>
  </button>

  <!-- Google AI Search (Semantic) -->
  <button
    id="google-ai-search-btn"
    class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-colors text-left border-t border-slate-100"
    aria-label="AI検索">
    <div class="w-10 h-10 bg-gradient-to-br from-brand-teal/10 to-brand-blue/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg class="w-5 h-5 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <div class="text-sm font-semibold text-slate-900">AI検索</div>
      <div class="text-xs text-slate-500">意味を理解して検索</div>
    </div>
  </button>
</div>

<script>
  const searchTrigger = document.getElementById('search-trigger');
  const searchMenu = document.getElementById('search-menu');
  const pagefindBtn = document.getElementById('pagefind-search-btn');
  const googleAiBtn = document.getElementById('google-ai-search-btn');
  const googleAiContainer = document.getElementById('google-ai-widget-container');
  const googleAiInput = document.getElementById('google-ai-search-trigger');

  let isMenuOpen = false;

  function toggleMenu(e?: Event) {
    if (e) e.stopPropagation();

    isMenuOpen = !isMenuOpen;

    if (isMenuOpen) {
      searchMenu?.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'false');
    } else {
      searchMenu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'true');
    }
  }

  function closeMenu() {
    if (isMenuOpen) {
      isMenuOpen = false;
      searchMenu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'true');
    }
  }

  // Toggle menu on search button click
  searchTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  // PageFind search - open modal and close menu
  pagefindBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeMenu();
    if ((window as any).openSearch) {
      (window as any).openSearch();
    }
  });

  // Google AI search - show widget container and focus input
  googleAiBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeMenu();

    // Show Google's widget container as a modal overlay
    if (googleAiContainer) {
      googleAiContainer.classList.remove('hidden');
      googleAiContainer.style.position = 'fixed';
      googleAiContainer.style.top = '0';
      googleAiContainer.style.left = '0';
      googleAiContainer.style.right = '0';
      googleAiContainer.style.bottom = '0';
      googleAiContainer.style.zIndex = '9999';
      googleAiContainer.style.display = 'flex';
      googleAiContainer.style.flexDirection = 'column';
      googleAiContainer.style.alignItems = 'center';
      googleAiContainer.style.justifyContent = 'flex-start';
      googleAiContainer.style.paddingTop = '15vh';
      googleAiContainer.style.backgroundColor = 'rgba(0,0,0,0.5)';
      googleAiContainer.style.backdropFilter = 'blur(4px)';

      // Focus the input after a short delay
      setTimeout(() => {
        googleAiInput?.focus();
      }, 100);
    }
  });

  // Close Google AI widget when clicking outside the input
  googleAiContainer?.addEventListener('click', (e) => {
    if (e.target === googleAiContainer) {
      googleAiContainer.classList.add('hidden');
      googleAiContainer.removeAttribute('style');
    }
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (isMenuOpen && !searchMenu?.contains(e.target as Node) && e.target !== searchTrigger) {
      closeMenu();
    }
  });

  // Close menu on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (isMenuOpen) {
        closeMenu();
      }
      if (!googleAiContainer?.classList.contains('hidden')) {
        googleAiContainer.classList.add('hidden');
        googleAiContainer.removeAttribute('style');
      }
    }
  });
</script>
