---
// SearchMenu.astro - AI Search dropdown menu (Google AI only)
---

<!-- Google Widget container - widget renders itself as full-screen dialog -->
<div id="google-ai-widget-container" class="google-ai-widget"></div>

<!-- Search Dropdown Menu -->
<div
  id="search-menu"
  class="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden transition-all duration-200 opacity-0 scale-95 pointer-events-none z-50"
  aria-hidden="true">

  <!-- Google AI Search (Semantic) -->
  <button
    id="google-ai-search-btn"
    class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-colors text-left"
    aria-label="AI検索">
    <div class="w-10 h-10 bg-gradient-to-br from-brand-teal/10 to-brand-blue/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg class="w-5 h-5 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <div class="text-sm font-semibold text-slate-900">AI検索</div>
      <div class="text-xs text-slate-500">意味を理解して検索</div>
    </div>
  </button>
</div>

<style>
  /* Google Widget container - holds the widget which creates its own dialog */
  .google-ai-widget {
    /* Widget creates its own full-screen dialog, so we just control visibility */
  }

  /* Widget renders itself with position: fixed and high z-index */
  .google-ai-widget gen-search-widget {
    display: block !important;
  }

  /* Override widget positioning to center the content area */
  .google-ai-widget gen-search-widget::part(dialog) {
    display: flex !important;
    align-items: flex-start !important;
    justify-content: center !important;
    padding-top: 20vh !important;
  }

  /* Style the widget's content area to look like PageFind */
  .google-ai-widget gen-search-widget::part(content) {
    max-width: 700px !important;
    width: 90% !important;
    background: white !important;
    border-radius: 1rem !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
  }

  /* Override backdrop to match PageFind */
  .google-ai-widget gen-search-widget::part(backdrop) {
    background: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(4px) !important;
  }
</style>

<script>
  const searchTrigger = document.getElementById('search-trigger');
  const searchMenu = document.getElementById('search-menu');
  const googleAiBtn = document.getElementById('google-ai-search-btn');
  let googleAiContainer = document.getElementById('google-ai-widget-container');

  let isMenuOpen = false;
  let googleScriptLoaded = false;
  let googleScriptLoading = false;
  let widgetCreated = false;

  // Dynamically load Google Widget script and create widget
  async function initGoogleWidget() {
    // Widget already created, nothing to do
    if (widgetCreated) {
      return;
    }

    try {
      // Load script if not already loaded
      if (!googleScriptLoaded && !googleScriptLoading) {
        googleScriptLoading = true;
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cloud.google.com/ai/gen-app-builder/client?hl=ja';
          script.async = true;
          script.onload = () => {
            googleScriptLoaded = true;
            googleScriptLoading = false;
            resolve(undefined);
          };
          script.onerror = () => {
            googleScriptLoading = false;
            reject(new Error('Failed to load Google Widget'));
          };
          document.head.appendChild(script);
        });
      }

      // Wait for custom element to be registered
      await new Promise(resolve => setTimeout(resolve, 500));

      // Get or create container (move to body to avoid z-index conflicts)
      googleAiContainer = document.getElementById('google-ai-widget-container');
      if (!googleAiContainer) {
        googleAiContainer = document.createElement('div');
        googleAiContainer.id = 'google-ai-widget-container';
        googleAiContainer.className = 'google-ai-widget';
        document.body.appendChild(googleAiContainer);
      } else if (googleAiContainer.parentElement !== document.body) {
        document.body.appendChild(googleAiContainer);
      }

      // Clear any existing content
      googleAiContainer.innerHTML = '';

      // Create the widget element
      const widget = document.createElement('gen-search-widget');
      widget.setAttribute('configId', 'bdff1d11-8603-47e8-851d-747312e6e3f5');
      widget.setAttribute('placeholder', '何でもお尋ねください...');
      widget.setAttribute('anchorsTarget', '_blank');
      widget.setAttribute('alwaysOpened', '');

      // Add widget directly to container (widget creates its own full-screen dialog)
      googleAiContainer.appendChild(widget);
      widgetCreated = true;

      // Focus the widget input after it renders
      setTimeout(() => {
        const input = widget?.querySelector('input[type="text"], input[type="search"]');
        input?.focus();

        // Add click listener to close widget when clicking outside content area
        // Note: backdrop is display:none in alwaysOpened mode, so we use dialog click
        try {
          const shadowRoot = widget?.shadowRoot;
          if (shadowRoot) {
            const dialog = shadowRoot.querySelector('[role="dialog"]');
            if (dialog) {
              dialog.addEventListener('click', (e) => {
                // Get the actual click position
                const x = e.clientX;
                const y = e.clientY;

                // Check if click is near the center (content area) or edges (should close)
                // Content is typically centered with max-width around 700px
                const viewportWidth = window.innerWidth;
                const centerX = viewportWidth / 2;
                const contentWidth = 700; // Approximate content width

                // Calculate content area bounds
                const contentLeft = centerX - contentWidth / 2;
                const contentRight = centerX + contentWidth / 2;

                // If click is outside horizontal content bounds, close widget
                if (x < contentLeft || x > contentRight) {
                  googleAiContainer!.innerHTML = '';
                  widgetCreated = false;
                }
              });
            }
          }
        } catch (err) {
          console.log('Could not add click listener to dialog:', err);
        }
      }, 1000);
    } catch (error) {
      console.error('Failed to initialize Google Widget:', error);
      alert('AI検索の読み込みに失敗しました。もう一度お試しください。');
    }
  }

  function toggleMenu(e?: Event) {
    if (e) e.stopPropagation();
    isMenuOpen = !isMenuOpen;

    if (isMenuOpen) {
      searchMenu?.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'false');
    } else {
      searchMenu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'true');
    }
  }

  function closeMenu() {
    if (isMenuOpen) {
      isMenuOpen = false;
      searchMenu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      searchMenu?.setAttribute('aria-hidden', 'true');
    }
  }

  // Toggle menu on search button click
  searchTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  // Google AI search - initialize and show widget
  googleAiBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeMenu();
    initGoogleWidget();
  });

  // Close dropdown menu when clicking outside
  document.addEventListener('click', (e) => {
    if (isMenuOpen && !searchMenu?.contains(e.target as Node) && e.target !== searchTrigger) {
      closeMenu();
    }

    // Close Google Widget when clicking outside content area
    const widget = googleAiContainer?.querySelector('gen-search-widget');
    if (widget) {
      const path = e.composedPath();

      // Check if click originated from widget
      if (path.includes(widget)) {
        // Calculate content area bounds (centered, ~700px wide)
        const viewportWidth = window.innerWidth;
        const centerX = viewportWidth / 2;
        const contentWidth = 700;
        const contentLeft = centerX - contentWidth / 2;
        const contentRight = centerX + contentWidth / 2;

        // If click is outside content bounds, close widget
        if (e.clientX < contentLeft || e.clientX > contentRight) {
          googleAiContainer!.innerHTML = '';
          widgetCreated = false;
        }
      }
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (isMenuOpen) closeMenu();

      // Close Google Widget
      const widget = googleAiContainer?.querySelector('gen-search-widget');
      if (widget) {
        googleAiContainer!.innerHTML = '';
        widgetCreated = false;
      }
    }
  });
</script>
